---
title: "Language use in tangrams"
author: "Robert Hawkins, Ashley Leung, and Dan Yurovsky"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: false
    number_sections: false
    theme: lumen
    toc_float: false
    code_folding: hide
---

## Imports 

```{r, message=FALSE, warning=FALSE, show = F}
library(tidyverse)
library(tidyboot)
library(janitor)
library(lme4)
library(lmerTest)
library(broom)

theme_set(theme_classic(base_size = 18))
```

## Aggregate csv files

```{r}
# get all files with participant data (this excludes meta.csv for now)
raw_csv_names <- dir(path = '../deidentified/', pattern = "*[0-9].csv", full.names = T)
meta <- read_csv('../deidentified/meta.csv')

raw_data <- raw_csv_names %>%
  map(read_csv) %>%             
  reduce(rbind) %>%                # read all csvs and combine into single data frame
  filter(type != 'practice') %>%   # remove practice trials
  group_by(subid, trial) %>%
  mutate(utt_number = row_number()) %>%
  group_by(subid, target) %>%
  mutate(rep_num = as.numeric(factor(trial))) %>%
  ungroup() %>%
  arrange(subid, trial) 

# Go through a lot of work just to get role mappings (ie. who is matcher, who is director?)
roles <- raw_data %>% filter(!is.na(selection)) %>% mutate(role = 'matcher') %>% 
  select(-type, -utterance, -correct, -selection, -target) %>% 
  rename(number_at_selection = utt_number) %>%
  complete(trial, nesting(subid, person)) %>%
  arrange(subid, trial) %>%
  mutate(role = ifelse(is.na(role), 'director', 'matcher')) %>%
  group_by(subid, trial) %>%
  mutate(number_at_selection = ifelse(is.na(first(number_at_selection)), 
                                      last(number_at_selection), 
                                      first(number_at_selection))) %>%
  mutate(rep_num = ifelse(is.na(first(rep_num)), last(rep_num), first(rep_num))) %>%
  ungroup()


data <- raw_data %>% 
  left_join(meta) %>%                          # combine with meta-data about age
  left_join(roles) %>%                         # combine with info about who had which role on each trial
  filter(utt_number < number_at_selection) %>% # remove utterances after selection was made
  group_by(subid, trial, person, role, target, rep_num) %>%
  summarize(utterance = paste0(utterance, collapse = ' '))

```

Write out combined data to import into python for nlp

```{r}
write_csv(data, '../deidentified/combined.csv')
```

## Sanity checks

check for coding errors

```{r}
raw_data %>% 
  group_by(subid, trial) %>% tally() %>% filter(n == 1) %>% select(-n) %>% # get trial #s with 1 event
  left_join(raw_data) %>%
  group_by(person) %>% tally()
```