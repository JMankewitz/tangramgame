---
title: "Tangram Transcripts"
author: "Ashley Leung, and Dan Yurovsky"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: false
    number_sections: false
    theme: lumen
    toc_float: false
    code_folding: hide
---
```{r, message=FALSE, warning=FALSE, show = F}
library(tidyverse)
library(here)
library(tidyboot)
library(knitr)

opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
               error = FALSE, cache = TRUE, tidy = FALSE)

theme_set(theme_classic(base_size = 18))
```

```{r read_data}
data <- read_csv(here("data/10606.csv")) %>%
  mutate(subid = "9") %>%
  filter(!is.na(Timeline.trial)) %>% 
  mutate(type = if_else(str_detect(Timeline.trial, "p"), "practice", 
                                   "test"),
         trial = as.numeric(gsub("[^0-9]", "", Timeline.trial)))

gametrials <- read_csv(here("data/tangramgameresults.csv")) %>%
  filter(subid == "9") %>%
  mutate(type = if_else(nchar(leftpic) > 2, "practice", "test")) %>%
  mutate(trial = as.numeric(trial)+1)
```

```{r munge_data}
tidy_data <- data %>%
  left_join(gametrials, c("subid", "trial", "type")) %>%
  gather(person, utterance, Timeline.parentspeech, Timeline.childspeech) %>%
   #mutate(utterance = if_else(utterance %in% c("<childspeech>", "<parentspeech>"),
   #                            as.character(NA), utterance)) %>%
   #mutate(utterance = if_else(is.na(utterance), as.character(NA), utterance)) %>%  
   mutate(selection = if_else(Timeline.selection == "parent", "parent",
                              if_else(Timeline.selection == "child",
                                      "child", as.character(NA)))) %>%
  filter(!is.na(selection) | !is.na(utterance)) %>%
  arrange(Timeline.ordinal) %>%
  mutate(person = if_else(str_detect(person, "parent"), "parent", "child")) %>%
  filter(is.na(selection) | selection == person) %>%
  group_by(subid, type, trial) %>%
  mutate(pos = 1:n(),
         select_pos = which.max(!is.na(selection)),
         trial_selection = last(unique(selection)))

```         
   
```{r conceptual_pacts}         
tidy_data %>%
  filter(type == "test", pos < select_pos) %>%
  mutate(length = str_count(utterance, " ") +1) %>%
  group_by(correct, target, trial) %>%
  summarise(length = sum(length, na.rm = T),
            nturns = n()) %>%
  group_by(target) %>%
  arrange(trial) %>%
  mutate(trial = 1:n()) %>%
  filter(correct == "Y") %>%
  group_by(trial) %>%
  tidyboot_mean(nturns) %>%
  ggplot(aes(x = trial, y = empirical_stat)) + 
  geom_line() + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper))
```

```{r accuracy}
gametrials %>% filter(type == "test") %>% 
  mutate(correct =  correct == "Y") %>%
  mutate(cum_correct = cummean(correct)) %>%
  ggplot(aes(x = trial, y = cum_correct)) + 
  geom_point()
```